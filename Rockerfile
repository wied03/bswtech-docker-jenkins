FROM centos:7
RUN yum install -y java-1.8.0-openjdk && yum clean all

ENV JENKINS_HOME {{ .JenkinsHome }}
ENV JENKINS_SLAVE_AGENT_PORT 50000
VOLUME {{ .JenkinsHome }}

ARG JENKINS_VERSION
ENV JENKINS_VERSION ${JENKINS_VERSION:-2.7.1}
ARG JENKINS_SHA
ENV JENKINS_SHA ${JENKINS_SHA:-12d820574c8f586f7d441986dd53bcfe72b95453}

RUN mkdir -p /usr/share/jenkins/ref/init.groovy.d

RUN curl -fsSL http://repo.jenkins-ci.org/public/org/jenkins-ci/main/jenkins-war/${JENKINS_VERSION}/jenkins-war-${JENKINS_VERSION}.war -o /usr/share/jenkins/jenkins.war \
  && echo "$JENKINS_SHA  /usr/share/jenkins/jenkins.war" | sha1sum -c

COPY init.groovy /usr/share/jenkins/ref/init.groovy.d/tcp-slave-agent-port.groovy

ENV COPY_REFERENCE_FILE_LOG $JENKINS_HOME/copy_reference_file.log

EXPOSE 8080

COPY jenkins.sh /usr/local/bin/jenkins.sh
ENTRYPOINT ["/usr/local/bin/jenkins.sh"]

TAG {{ .ImageTag }}
