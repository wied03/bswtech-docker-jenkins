FROM quay.io/brady/bswtech-docker-base:{{ .BaseVersion }}

MOUNT .:/src

ENV JENKINS_HOME /var/jenkins_home
ENV JENKINS_SLAVE_AGENT_PORT 50000
# from RPM
ENV JENKINS_APP_DIR {{ .JenkinsBinDir }}/app
ENV JENKINS_REF_DIR {{ .JenkinsBinDir }}/ref
ENV JENKINS_PLUGIN_DIR {{ .JenkinsBinDir }}/plugins
ARG JENKINS_WAR_FILE={{ .JenkinsBinDir }}/jenkins.war

RUN curl http://pkg.jenkins-ci.org/redhat-stable/jenkins.repo -o /etc/yum.repos.d/jenkins.repo \
 && rpm --import /src/jenkins-ci.org.key \
 # EPEL needed for tomcat-native
 && yum_check.sh epel-release \
 # Tomcat is more controllable than the Winstone hack Jenkins comes with
 # And it's an existing RPM within the CentOS ecosystem (security notifications, etc.)
 && yum_check.sh {{ .JavaPackage }} jenkins-{{ .JenkinsVersion }} {{ .GitPackage }} tomcat-7.0.76-3.el7_4 tomcat-native unzip \
 # trading in faster startup for image size
 && unzip ${JENKINS_WAR_FILE} -d ${JENKINS_APP_DIR} \
 # See above for why no Winstone
 && rm ${JENKINS_WAR_FILE} ${JENKINS_APP_DIR}/winstone.jar \
 && ln -s ${JENKINS_APP_DIR} /var/lib/tomcat/webapps/ROOT \
 && yum remove -y unzip \
 && yum clean all \
 && yum autoremove -y \
 && rm -rfv /tmp/*

# Now pre-load our plugins into the image
RUN echo {{ .PluginHash }} \
  && cp -R /src/plugins/plugins_final $JENKINS_PLUGIN_DIR/

# RPM puts a user in there but we want control over the GID
RUN mkdir $JENKINS_HOME \
 && mkdir -p $JENKINS_REF_DIR/init.groovy.d \
 # Keep track of version in the footer
 && printf ".jenkins_ver:after {\n        content: \" - I{{ .ImageVersion }}\";\n}\n" >> ${JENKINS_APP_DIR}/css/layout-common.css \
 && cp -v /src/resources/*.properties /etc/tomcat/ \
 && rm /etc/tomcat/server.xml \
 # Make this configurable from the volume
 && echo Resource Hash {{ .ResourcesHash }} \
 && ln -s ${JENKINS_HOME}/server.xml /etc/tomcat/server.xml \
 && cp -v /src/resources/server.xml $JENKINS_REF_DIR \
 && cp -v /src/resources/jenkins.sh /usr/local/bin/ \
 # Longer timeout by default
 && sed -i 's/<session-timeout>30<\/session-timeout>/<session-timeout>60<\/session-timeout>/' /etc/tomcat/web.xml \
 # Our own plugin manager to deal with pre-loaded plugins
 && cp -v /src/build/libs/bswtech-docker-jenkins.jar ${JENKINS_APP_DIR}/WEB-INF/lib/ \
 && cp -v /src/resources/init.groovy $JENKINS_REF_DIR/init.groovy.d/tcp-slave-agent-port.groovy \
 && rm -rfv /usr/share/tomcat/work \
 && rm /etc/tomcat/tomcat-users.xml

VOLUME ["${JENKINS_HOME}"]

EXPOSE 8080

ENTRYPOINT ["/bin/tini", "-v", "--", "/usr/local/bin/jenkins.sh"]

LABEL Version={{ .ImageVersion }}

TAG {{ .ImageTag }}
